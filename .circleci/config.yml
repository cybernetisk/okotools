version: 2

jobs:
  build:
    working_directory: ~/build
    docker:
      - image: node:7.8
    steps:
      - checkout

      - restore_cache:
          key: okoreports-frontend-{{ .Branch }}-{{ checksum "tripletexweb/frontend/package.json" }}

      - run:
          name: Install dependencies
          working_directory: tripletexweb/frontend
          command: npm install

      - save_cache:
          key: okoreports-frontend-{{ .Branch }}-{{ checksum "tripletexweb/frontend/package.json" }}
          paths:
            - "~/build/tripletexweb/frontend/node_modules"

      - run:
          name: Compile production artifact
          working_directory: tripletexweb/frontend
          command: npm run compile:prod

      - setup_remote_docker

      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      - run:
          name: Install Docker Compose
          command: |
            set -x
            curl -L https://github.com/docker/compose/releases/download/1.11.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose

      - run:
          name: Build frontend docker image
          working_directory: tripletexweb/frontend
          command: |
            docker-compose build frontend

      - deploy:
          name: Push docker image to Docker Hub if master branch
          working_directory: tripletexweb/frontend
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
              docker-compose push frontend
            fi
